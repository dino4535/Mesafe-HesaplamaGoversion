<!doctype html>
<html lang="tr">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>POS Mesafe Uygulaması</title>
    <style>
      :root {
        --primary-color: #4361ee;
        --secondary-color: #3f37c9;
        --success-color: #4cc9f0;
        --warning-color: #f72585;
        --light-bg: #f8f9fa;
        --dark-text: #212529;
        --border-color: #dee2e6;
        --card-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      }
      
      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }
      
      body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        margin: 0;
        padding: 20px;
        background-color: #f5f7fb;
        color: var(--dark-text);
        line-height: 1.6;
      }
      
      .container {
        max-width: 800px;
        margin: 0 auto;
        background: white;
        border-radius: 12px;
        box-shadow: var(--card-shadow);
        padding: 30px;
        position: relative;
      }
      
      .logout-btn {
        position: absolute;
        top: 20px;
        right: 20px;
        background-color: #dc3545;
        color: white;
        border: none;
        border-radius: 4px;
        padding: 8px 16px;
        cursor: pointer;
        font-size: 0.9rem;
        text-decoration: none;
        transition: background-color 0.3s;
      }
      
      .logout-btn:hover {
        background-color: #c82333;
      }
      
      header {
        text-align: center;
        margin-bottom: 30px;
        padding-bottom: 20px;
        border-bottom: 1px solid var(--border-color);
      }
      
      h2 {
        color: var(--primary-color);
        margin-bottom: 10px;
        font-size: 2rem;
      }
      
      .subtitle {
        color: #6c757d;
        font-size: 1rem;
      }
      
      .disclaimer {
        background: #fff3cd;
        border: 1px solid #ffeaa7;
        border-radius: 8px;
        padding: 15px;
        margin: 20px 0;
        font-size: 0.9rem;
        color: #856404;
      }
      
      label {
        display: block;
        margin-top: 15px;
        font-weight: 600;
        color: #495057;
      }
      
      input[type="text"], input[type="number"], select, input[type="file"] {
        width: 100%;
        padding: 12px;
        border: 1px solid var(--border-color);
        border-radius: 6px;
        font-size: 1rem;
        transition: border-color 0.3s;
      }
      
      input[type="file"] {
        padding: 8px;
      }
      
      input[type="text"]:focus, input[type="number"]:focus, select:focus, input[type="file"]:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.2);
      }
      
      .file-upload-wrapper {
        position: relative;
        overflow: hidden;
        display: inline-block;
        width: 100%;
      }
      
      .file-upload-wrapper input[type="file"] {
        position: absolute;
        left: 0;
        top: 0;
        opacity: 0;
        width: 100%;
        height: 100%;
        cursor: pointer;
      }
      
      .file-upload-button {
        display: block;
        padding: 12px;
        background: #e9ecef;
        border: 1px dashed var(--border-color);
        border-radius: 6px;
        text-align: center;
        cursor: pointer;
        transition: background-color 0.3s;
      }
      
      .file-upload-button:hover {
        background: #dde0e3;
      }
      
      .file-name {
        margin-top: 8px;
        font-size: 0.9rem;
        color: #6c757d;
      }
      
      .row {
        display: flex;
        gap: 20px;
        margin-top: 15px;
      }
      
      .row > div {
        flex: 1;
      }
      
      button {
        margin-top: 25px;
        padding: 12px 24px;
        background-color: var(--primary-color);
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-size: 1rem;
        font-weight: 600;
        width: 100%;
        transition: background-color 0.3s;
      }
      
      button:hover {
        background-color: var(--secondary-color);
      }
      
      .msg {
        margin-top: 20px;
        padding: 15px;
        background: #e7f5ff;
        border: 1px solid #c2e0ff;
        border-radius: 6px;
        color: #228be6;
      }
      
      .result {
        margin-top: 20px;
        padding: 15px;
        background: #f8f9fa;
        border: 1px solid var(--border-color);
        border-radius: 6px;
      }
      
      .result strong {
        color: var(--primary-color);
      }
      
      h3 {
        margin: 25px 0 15px 0;
        color: #495057;
        font-size: 1.2rem;
      }
      
      #logBox {
        max-height: 240px;
        overflow: auto;
        border: 1px solid var(--border-color);
        padding: 15px;
        background: #fafafa;
        border-radius: 6px;
        font-family: monospace;
        font-size: 0.9rem;
      }
      
      /* Loading animation */
      .loading-container {
        display: none;
        margin-top: 15px;
        padding: 15px;
        background: #f0f8ff;
        border: 1px solid #b0d4f1;
        border-radius: 6px;
      }
      
      .loading-text {
        text-align: center;
        margin-bottom: 10px;
        color: #4361ee;
        font-weight: 500;
      }
      
      .spinner {
        width: 40px;
        height: 40px;
        border: 4px solid #e0e0e0;
        border-top: 4px solid var(--primary-color);
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 0 auto;
      }
      
      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }
      
      .progress-bar {
        width: 100%;
        height: 10px;
        background-color: #e0e0e0;
        border-radius: 5px;
        margin-top: 15px;
        overflow: hidden;
      }
      
      .progress-bar-fill {
        height: 100%;
        background: linear-gradient(90deg, var(--primary-color), var(--success-color));
        width: 0%;
        transition: width 0.3s ease;
      }
      
      .download-link {
        display: inline-block;
        margin-top: 15px;
        padding: 10px 15px;
        background-color: var(--success-color);
        color: white;
        text-decoration: none;
        border-radius: 6px;
        font-weight: 500;
        transition: background-color 0.3s;
      }
      
      .download-link:hover {
        background-color: #3aa8d0;
        color: white;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <a href="/logout" class="logout-btn">Çıkış Yap</a>
      
      <header>
        <h2>POS Mesafe Uygulaması</h2>
        <p class="subtitle">Konum tabanlı en yakın nokta hesaplama aracı</p>
      </header>
      
      <div class="disclaimer">
        <strong>Dikkat:</strong> Bu sistemde işlenecek tüm veriler kullanıcı sorumluluğundadır. 
        Sistem sadece hesaplama işlemleri yapmakta olup, işlenen verilerden sorumlu değildir.
      </div>
      
      <p><a href="/download-template" style="color: var(--primary-color); text-decoration: none; font-weight: 500; display: inline-flex; align-items: center;">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16" style="margin-right: 8px;">
          <path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"/>
          <path d="M7.646 11.854a.5.5 0 0 0 .708 0l3-3a.5.5 0 0 0-.708-.708L8.5 10.293V1.5a.5.5 0 0 0-1 0v8.793L5.354 8.146a.5.5 0 1 0-.708.708l3 3z"/>
        </svg>
        Şablon dosyasını indir
      </a></p>
      
      <form method="post" action="/run" enctype="multipart/form-data">
        <label>Giriş dosyası (Excel)</label>
        <div class="file-upload-wrapper">
          <input type="file" name="input_file" accept=".xlsx,.xls" id="inputFile" />
          <div class="file-upload-button" id="uploadButton">Dosya seçin veya buraya sürükleyin</div>
        </div>
        <div class="file-name" id="fileName">Hiçbir dosya seçilmedi</div>

        <div class="row">
          <div>
            <label>Mod</label>
            <select name="mode">
              <option value="nearest">En Yakın</option>
              <option value="radius">Metreye Göre</option>
            </select>
          </div>
          <div>
            <label>Metre (radius modunda)</label>
            <input type="number" name="meters" min="1" step="1" placeholder="örn. 500" />
          </div>
        </div>

        <button type="submit">Hesapla</button>
      </form>

      {% if message %}
      <div class="msg">{{ message }}</div>
      {% endif %}

      {% if result %}
      <div class="result">
        <div>Mod: <strong>{{ result.mode }}</strong></div>
        <div>Satır sayısı: <strong>{{ result.rows }}</strong></div>
        <div>Sayfa: <strong>{{ result.sheet }}</strong></div>
        <div>
          <a href="/download-result/{{ result.output.split('/')[-1] if '/' in result.output else result.output.split('\\')[-1] }}" class="download-link">
            Sonuç Dosyasını İndir
          </a>
        </div>
      </div>
      {% endif %}

      <h3>İşlem Durumu</h3>
      <div id="logBox" style="max-height: 240px; overflow: auto; border: 1px solid var(--border-color); padding: 15px; background: #fafafa; border-radius: 6px; font-family: monospace; font-size: 0.9rem;"></div>

      <!-- Loading animation container -->
      <div id="loadingContainer" class="loading-container">
        <div class="loading-text">İşlem devam ediyor, lütfen bekleyin...</div>
        <div class="spinner"></div>
        <div class="progress-bar">
          <div id="progressBarFill" class="progress-bar-fill"></div>
        </div>
      </div>

      <div id="resultBox" class="result" style="display:none;"></div>

      <script>
        // File upload handling
        const inputFile = document.getElementById('inputFile');
        const uploadButton = document.getElementById('uploadButton');
        const fileNameDisplay = document.getElementById('fileName');
        
        inputFile.addEventListener('change', function() {
          if (this.files.length > 0) {
            fileNameDisplay.textContent = this.files[0].name;
          } else {
            fileNameDisplay.textContent = 'Hiçbir dosya seçilmedi';
          }
        });
        
        // Drag and drop functionality
        uploadButton.addEventListener('dragover', function(e) {
          e.preventDefault();
          this.style.backgroundColor = '#dde0e3';
        });
        
        uploadButton.addEventListener('dragleave', function() {
          this.style.backgroundColor = '';
        });
        
        uploadButton.addEventListener('drop', function(e) {
          e.preventDefault();
          this.style.backgroundColor = '';
          
          if (e.dataTransfer.files.length) {
            inputFile.files = e.dataTransfer.files;
            fileNameDisplay.textContent = e.dataTransfer.files[0].name;
          }
        });

        const jobId = '{{ job_id if job_id else "" }}';
        const logBox = document.getElementById('logBox');
        const resultBox = document.getElementById('resultBox');
        const loadingContainer = document.getElementById('loadingContainer');
        const progressBarFill = document.getElementById('progressBarFill');

        async function fetchLogs() {
          if (!jobId) return;
          try {
            const res = await fetch(`/logs?job_id=${jobId}`);
            const data = await res.json();
            if (data.ok) {
              logBox.innerHTML = data.logs.map(l => `<div>${l}</div>`).join('');
              logBox.scrollTop = logBox.scrollHeight;
              
              // Show loading animation when processing
              if (data.status === 'running') {
                loadingContainer.style.display = 'block';
                
                // Update progress bar based on progress value
                if (data.progress !== undefined) {
                  progressBarFill.style.width = `${data.progress}%`;
                }
              } else {
                loadingContainer.style.display = 'none';
              }
              
              if (data.status === 'done' || data.status === 'error') {
                clearInterval(window.__logTimer);
                const sres = await fetch(`/status?job_id=${jobId}`);
                const sdata = await sres.json();
                if (sdata.ok) {
                  resultBox.style.display = 'block';
                  if (sdata.status === 'done' && sdata.result) {
                    const r = sdata.result;
                    resultBox.innerHTML = `
                      <div>Mod: <strong>${r.mode}</strong></div>
                      <div>Satır sayısı: <strong>${r.rows}</strong></div>
                      <div>Sayfa: <strong>${r.sheet}</strong></div>
                      <div><a href="/download-result/${r.output.split('/').pop().split('\\\\').pop()}" class="download-link">Sonuç Dosyasını İndir</a></div>
                    `;
                  } else {
                    resultBox.innerHTML = `<div>Hata: ${sdata.error || 'Bilinmeyen hata'}</div>`;
                  }
                }
              }
            }
          } catch (e) {
            console.error('Log fetch error', e);
          }
        }

        if (jobId) {
          window.__logTimer = setInterval(fetchLogs, 1000);
          fetchLogs();
        }
      </script>
    </div>
    
    <!-- Corporate footer notice -->
    <div style="position: fixed; bottom: 0; left: 0; right: 0; background: linear-gradient(to right, #2c3e50, #4a6491); padding: 15px; color: white; font-size: 13px; text-align: center;">
      <p style="margin: 0;">© 2026 Oğuz EMÜL. Tüm hakları saklıdır. Bu uygulama sadece yetkili kullanıcılar tarafından kullanılabilir. Kopyalanması ve paylaşılması izinsiz yapılamaz.</p>
    </div>
  </body>
</html>